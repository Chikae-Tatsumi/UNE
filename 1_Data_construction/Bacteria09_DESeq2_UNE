# Deseq2 (https://joey711.github.io/phyloseq-extensions/DESeq2.html)
library("DESeq2"); packageVersion("DESeq2")

# Import files
design <- read.csv("~/R/Analysis/2_UNE/16S/experimental_design.csv",header=T)
seqtab.nochim <- read.table("~/R/Analysis/2_UNE/seqtabnochim.txt",header=T)
seqtab.nochim <- as.matrix(seqtab.nochim)
taxa <- read.table("~/R/Analysis/2_UNE/16S/taxonomy.txt",header=T)
taxa <- as.matrix(taxa)

rownames(design) <- rownames(seqtab.nochim)
ps.deseq <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), 
                         tax_table(taxa), sample_data(design))
                         
dna <- Biostrings::DNAStringSet(taxa_names(ps.deseq))
names(dna) <- taxa_names(ps.deseq)
ps.deseq <- merge_phyloseq(ps.deseq, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps.deseq)))
ps.deseq        

# Remove non-bacterial ASVs
ps.deseq = subset_taxa(ps.deseq,(Kingdom=="Bacteria"))
ps.deseq = subset_taxa(ps.deseq,(Family  != "Mitochondria"|is.na(Family) &
                             Order   != "Chloroplast"|is.na(Order)))

# DESeq2 conversion and call (see https://bioconductor.org/packages/devel/bioc/vignettes/phyloseq/inst/doc/phyloseq-mixture-models.html)
diagdds = phyloseq_to_deseq2(ps.deseq, ~DFB*DFE)
gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
geoMeans = apply(counts(diagdds), 1, gm_mean)

gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
geoMeans = apply(counts(diagdds), 1, gm_mean)
diagdds = estimateSizeFactors(diagdds, geoMeans = geoMeans)
diagdds = DESeq(diagdds, fitType="local")

# Investigate test results table
res = results(diagdds, cooksCutoff = FALSE)
alpha = 0.01
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(ps)[rownames(sigtab), ], "matrix"))
head(sigtab)
dim(sigtab)

# Get ASV table (https://github.com/joey711/phyloseq/issues/283)
diagdds = estimateDispersions(diagdds)
diagvst = getVarianceStabilizedData(diagdds)
dim(diagvst)
diagvst = diagvst-min(diagvst)

otu_table(ps.deseq) <- otu_table(diagvst, taxa_are_rows = TRUE)

# Save
otu_table<-diagvst
ps.t<-cbind(otu_table,ps.deseq@tax_table)
write.table(ps.t,  file="deseq_ASV_table.txt")

# ADONIS for DESeq
library (vegan)
Seq_Depth <- rowSums(seqtab.nochim)
comm<- t(diagvst)
sink(file = "adonis.seq_depthforDESeq.doc")
adonis(comm ~ Seq_Depth, permutations=5000)
sink()
